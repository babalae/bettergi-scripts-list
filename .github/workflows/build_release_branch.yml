name: Scheduled Build and Release

on:
  schedule:
    # æ¯å¤©ä¸‹åˆ18ç‚¹æ‰§è¡Œ (UTCæ—¶é—´10ç‚¹)
    - cron: '0 10 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    if: github.repository_owner == 'babalae'
    
    permissions:
      contents: write
      actions: read
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç ä»“åº“
      uses: actions/checkout@v4
      with:
        path: bettergi-scripts-list
        fetch-depth: 0
    
    - name: ğŸš€ é…ç½® Node.js ç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: '22'
    
    - name: ğŸ”¨ æ„å»ºé¡¹ç›®å¹¶ç”Ÿæˆæ–‡ä»¶
      run: |
        echo "ğŸ”„ å¼€å§‹æ„å»ºé¡¹ç›®..."
        cd bettergi-scripts-list
        echo "ğŸ“¦ æ‰§è¡Œæ„å»ºè„šæœ¬ (å¼ºåˆ¶æ¨¡å¼ + Gzipå‹ç¼©)"
        node ./build/build.js --force --gzip
        echo "âœ… é¡¹ç›®æ„å»ºå®Œæˆ"
    
    - name: ğŸ“‹ å¤åˆ¶ç”Ÿæˆçš„æ–‡ä»¶åˆ°å·¥ä½œç›®å½•
      run: |
        echo "ğŸ“‚ å¤åˆ¶ repo.json å’Œ repo.json.gz æ–‡ä»¶..."
        cp bettergi-scripts-list/repo.json .
        cp bettergi-scripts-list/repo.json.gz .
        echo "âœ… æ–‡ä»¶å¤åˆ¶å®Œæˆ"
        ls -la *.json*
    
    - name: ğŸ§¹ æ¸…ç†å·¥ä½œç›®å½•å˜æ›´
      run: |
        echo "ğŸ”„ æ¸…ç† bettergi-scripts-list ç›®å½•ä¸­çš„å˜æ›´..."
        cd bettergi-scripts-list
        git checkout -- .
        git clean -fd
        echo "âœ… å·¥ä½œç›®å½•æ¸…ç†å®Œæˆ"
    
    - name: ğŸŒ¿ å‡†å¤‡ Release åˆ†æ”¯
      run: |
        echo "ğŸ”„ å¼€å§‹å‡†å¤‡ Release åˆ†æ”¯..."
        cd bettergi-scripts-list
        
        echo "ğŸ—‘ï¸ åˆ é™¤æœ¬åœ° release åˆ†æ”¯ï¼ˆå¦‚æœå­˜åœ¨ï¼‰"
        git branch -D release || true
        
        echo "ğŸ†• åˆ›å»ºæ–°çš„ orphan åˆ†æ”¯"
        git checkout --orphan release
        git rm -rf .
        
        echo "ğŸ“¦ æ£€å‡º main åˆ†æ”¯çš„å†…å®¹åˆ°å·¥ä½œåŒº"
        git checkout main -- repo packages .gitignore
        
        echo "ğŸ“‹ å¤åˆ¶ç”Ÿæˆçš„æ–‡ä»¶åˆ° release åˆ†æ”¯"
        cp ../repo.json .
        cp ../repo.json.gz .
        
        echo "ğŸ“Š æ˜¾ç¤ºå½“å‰æ–‡ä»¶çŠ¶æ€"
        ls -la
        echo "âœ… Release åˆ†æ”¯å‡†å¤‡å®Œæˆ"
    
    - name: ğŸš€ æäº¤å¹¶æ¨é€åˆ° Release åˆ†æ”¯
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "rebuild release branch"
        branch: release
        push_options: '--force'
        repository: bettergi-scripts-list
        file_pattern: .
        skip_dirty_check: true
        skip_fetch: false
        skip_checkout: true
        create_branch: false
