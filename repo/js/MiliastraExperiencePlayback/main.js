/**
 * Better Genshin Impact JavaScript
 * Bundled with BetterGI CLI (https://www.npmjs.com/package/@bettergi/cli)
 * 
 * This file is automatically generated and should not be edited.
 */

// node_modules/.pnpm/@bettergi+utils@0.1.19/node_modules/@bettergi/utils/dist/workflow.js
var defaultMaxAttempts = 5;
var defaultRetryInterval = 1e3;
var waitForAction = async (condition, retryAction, options) => {
  const { maxAttempts = defaultMaxAttempts, retryInterval = defaultRetryInterval } = options || {};
  for (let i = 0; i < maxAttempts; i++) {
    if (i === 0 && condition())
      return true;
    await retryAction?.();
    await sleep(retryInterval);
    if (condition())
      return true;
  }
  return false;
};
var waitForRegionAppear = async (regionProvider, retryAction, options) => {
  return waitForAction(() => {
    const region = regionProvider();
    return region != null && region.isExist();
  }, retryAction, options);
};
var waitForRegionDisappear = async (regionProvider, retryAction, options) => {
  return waitForAction(() => {
    const region = regionProvider();
    return !region || !region.isExist();
  }, retryAction, options);
};

// node_modules/.pnpm/@bettergi+utils@0.1.19/node_modules/@bettergi/utils/dist/asserts.js
var assertRegionAppearing = async (regionProvider, message, retryAction, options) => {
  const isAppeared = await waitForRegionAppear(regionProvider, retryAction, options);
  if (!isAppeared) {
    throw new Error(message);
  }
};
var assertRegionDisappearing = async (regionProvider, message, retryAction, options) => {
  const isDisappeared = await waitForRegionDisappear(regionProvider, retryAction, options);
  if (!isDisappeared) {
    throw new Error(message);
  }
};

// node_modules/.pnpm/@bettergi+utils@0.1.19/node_modules/@bettergi/utils/dist/exception.js
var getErrorMessage = (err) => {
  if (err && "message" in err && typeof err.message === "string")
    return err.message;
  return err && typeof err === "object" ? JSON.stringify(err) : "Unknown error";
};
var isHostException = (err) => {
  return err && "hostException" in err;
};

// node_modules/.pnpm/@bettergi+utils@0.1.19/node_modules/@bettergi/utils/dist/mouse.js
var simulateScroll = async (scrollAmountInClicks, times) => {
  const script = {
    macroEvents: Array(times).fill({ type: 6, mouseX: 0, mouseY: scrollAmountInClicks, time: 0 }),
    info: { name: "", description: "", x: 0, y: 0, width: 1920, height: 1080, recordDpi: 1.5 }
  };
  await keyMouseScript.run(JSON.stringify(script));
};
var mouseScrollDown = (height, algorithm = (h) => Math.floor(h / 18)) => {
  return simulateScroll(-120, algorithm(height));
};
var mouseScrollDownLines = (lines, lineHeight = 175) => {
  return mouseScrollDown(lines * lineHeight);
};

// node_modules/.pnpm/@bettergi+utils@0.1.19/node_modules/@bettergi/utils/dist/ocr.js
var findImageWithinBounds = (image, x, y, w, h, config = {}) => {
  const ir = captureGameRegion();
  try {
    const mat = typeof image === "string" ? file.readImageMatSync(image) : image;
    const ro = RecognitionObject.templateMatch(mat, x, y, w, h);
    if (Object.keys(config).length > 0) {
      Object.assign(ro, config) && ro.initTemplate();
    }
    const region = ir.find(ro);
    return region.isExist() ? region : void 0;
  } catch (err) {
    log.warn(`${err.message || err}`);
  } finally {
    ir.dispose();
  }
};
var findFirst = (ir, ro, predicate) => {
  const candidates = ir.findMulti(ro);
  for (let i = 0; i < candidates.count; i++) {
    if (predicate(candidates[i]))
      return candidates[i];
  }
  return void 0;
};
var findTextWithinBounds = (text, x, y, w, h, options, config = {}) => {
  const { ignoreCase = true, contains = false } = options || {};
  const searchText = ignoreCase ? text.toLowerCase() : text;
  const ir = captureGameRegion();
  try {
    const ro = RecognitionObject.ocr(x, y, w, h);
    if (Object.keys(config).length > 0) {
      Object.assign(ro, config) && ro.initTemplate();
    }
    return findFirst(ir, ro, (region) => {
      const itemText = ignoreCase ? region.text.toLowerCase() : region.text;
      const isMatch = contains ? itemText.includes(searchText) : itemText === searchText;
      return isMatch && region.isExist();
    });
  } catch (err) {
    log.warn(`${err.message || err}`);
  } finally {
    ir.dispose();
  }
};
var findTextWithinListView = async (text, listView, matchOptions, retryOptions, config = {}) => {
  const { x, y, w, h, lineHeight, scrollLines = 1, paddingX = 10, paddingY = 10 } = listView;
  const { maxAttempts = 30, retryInterval = 1e3 } = retryOptions || {};
  const findTargetText = () => findTextWithinBounds(text, x, y, w, h, matchOptions, config);
  let lastTextRegion;
  const isReachedBottom = () => {
    const textRegion = findFirst(captureGameRegion(), RecognitionObject.ocr(x, y, w, h), (region) => {
      return region.isExist() && region.text.trim().length > 0;
    });
    if (textRegion) {
      if (lastTextRegion?.text === textRegion.text && Math.abs(textRegion.y - lastTextRegion.y) < lineHeight) {
        return true;
      } else {
        lastTextRegion = textRegion;
        return false;
      }
    }
    return true;
  };
  const isTextFoundOrBottomReached = await waitForAction(() => findTargetText() != void 0 || isReachedBottom(), async () => {
    moveMouseTo(x + w - paddingX, y + paddingY);
    await sleep(50);
    await mouseScrollDownLines(scrollLines, lineHeight);
  }, { maxAttempts, retryInterval });
  return isTextFoundOrBottomReached ? findTargetText() : void 0;
};

// node_modules/.pnpm/@bettergi+utils@0.1.19/node_modules/@bettergi/utils/dist/misc.js
var deepMerge = (...objects) => {
  const isPlainObject = (input) => input?.constructor === Object;
  return objects.reduce((result, obj) => {
    return Object.entries(obj).reduce((acc, [key, value]) => {
      const recursive = isPlainObject(acc[key]) && isPlainObject(value);
      acc[key] = recursive ? deepMerge(acc[key], value) : value;
      return acc;
    }, result);
  }, {});
};

// node_modules/.pnpm/@bettergi+utils@0.1.19/node_modules/@bettergi/utils/dist/time.js
var getNextMonday4AM = () => {
  const now = /* @__PURE__ */ new Date();
  const result = new Date(now);
  result.setHours(4, 0, 0, 0);
  const currentDay = now.getDay();
  const daysUntilNextMonday = currentDay === 1 && now.getHours() < 4 ? 0 : 8 - currentDay;
  result.setDate(now.getDate() + daysUntilNextMonday);
  return result;
};
var parseDuration = (duration) => {
  return {
    h: Math.floor(duration / 36e5),
    m: Math.floor(duration % 36e5 / 6e4),
    s: Math.floor(duration % 6e4 / 1e3),
    ms: Math.floor(duration % 1e3)
  };
};
var formatDurationAsClock = (duration) => {
  return Object.values(parseDuration(duration)).slice(0, 3).map((num) => String(num).padStart(2, "0")).join(":");
};
var formatDurationAsReadable = (duration) => {
  return Object.entries(parseDuration(duration)).filter(([, value]) => value > 0).map(([unit, value]) => `${value}${unit}`).join(" ");
};

// node_modules/.pnpm/@bettergi+utils@0.1.19/node_modules/@bettergi/utils/dist/progress.js
var ProgressTracker = class {
  total = 0;
  current = 0;
  startTime = Date.now();
  formatter;
  interval;
  lastPrintTime = 0;
  constructor(total, config) {
    const { formatter, interval = 3e3 } = config || {};
    this.total = total;
    this.formatter = formatter || this.defaultFormatter;
    this.interval = interval;
  }
  defaultFormatter = (logger, message, progress) => {
    logger("[ğŸš§ {pct} â³ {eta}]: {msg}", progress.formatted.percentage.padStart(6), progress.current > 0 && progress.elapsed > 0 ? progress.formatted.remaining : "--:--:--", message);
  };
  tick(options) {
    const { increment = 1, message, force = false } = options || {};
    this.current = Math.min(this.current + increment, this.total);
    if (message)
      this.print(message, force);
    return this.current === this.total;
  }
  complete(message) {
    this.current = this.total;
    this.print(message, true);
  }
  reset() {
    this.current = 0;
    this.startTime = Date.now();
    this.lastPrintTime = 0;
  }
  print(message, force = false, logger = log.info) {
    if (force || this.shouldPrint()) {
      this.formatter(logger, message, this.getProgress());
      this.printed();
    }
  }
  shouldPrint() {
    return Date.now() - this.lastPrintTime >= this.interval;
  }
  printed() {
    this.lastPrintTime = Date.now();
  }
  getProgress() {
    const percentage = this.current / this.total;
    const elapsed = Date.now() - this.startTime;
    const average = this.current > 0 ? elapsed / this.current : 0;
    const remaining = (this.total - this.current) * average;
    return {
      current: this.current,
      total: this.total,
      percentage,
      elapsed,
      average,
      remaining,
      formatted: {
        percentage: `${(percentage * 100).toFixed(1)}%`,
        elapsed: formatDurationAsReadable(elapsed),
        average: formatDurationAsReadable(average),
        remaining: formatDurationAsClock(remaining)
      }
    };
  }
};

// node_modules/.pnpm/@bettergi+utils@0.1.19/node_modules/@bettergi/utils/dist/store.js
var useStore = (name) => {
  const filePath = `store/${name}.json`;
  const obj = (() => {
    try {
      const storeFiles = [...file.readPathSync("store")].map((path) => path.replace(/\\/g, "/"));
      if (!storeFiles.includes(filePath))
        throw new Error("File does not exist");
      const text = file.readTextSync(filePath);
      return JSON.parse(text);
    } catch {
      return {};
    }
  })();
  const createProxy = (target, parentPath = []) => {
    if (typeof target !== "object" || target === null) {
      return target;
    }
    return new Proxy(target, {
      get: (target2, key) => {
        const value = Reflect.get(target2, key);
        return typeof value === "object" && value !== null ? createProxy(value, [...parentPath, key]) : value;
      },
      set: (target2, key, value) => {
        const success = Reflect.set(target2, key, value);
        if (success) {
          Promise.resolve().then(() => {
            file.writeTextSync(filePath, JSON.stringify(obj, null, 2));
          });
        }
        return success;
      },
      deleteProperty: (target2, key) => {
        const success = Reflect.deleteProperty(target2, key);
        if (success) {
          Promise.resolve().then(() => {
            file.writeTextSync(filePath, JSON.stringify(obj, null, 2));
          });
        }
        return success;
      }
    });
  };
  return createProxy(obj);
};
var useStoreWithDefaults = (name, defaults) => {
  const store = useStore(name);
  Object.assign(store, deepMerge(defaults, store));
  return store;
};

// src/config.ts
var userConfig = {
  room: settings.room || "20134075027",
  playbacks: (settings.playbacks || "é€šå…³å›æ”¾1.json,é€šå…³å›æ”¾2.json").replace(/ï¼Œ/g, ",").split(",").map((str) => str.trim()).filter(Boolean),
  expPerAttempt: Math.max(1, Number(settings.expPerAttempt || "20")),
  deleteStageSave: settings.deleteStageSave ?? false,
  deleteStageSaveKeyword: settings.deleteStageSaveKeyword || "æ·±æ¸Š100å±‚",
  expWeeklyLimit: Math.max(1, Number(settings.expWeeklyLimit || "4000")),
  force: settings.force ?? false,
  thisAttempts: Math.max(0, Number(settings.thisAttempts || "0")),
  goToTeyvat: settings.goToTeyvat ?? true
};

// src/regions.ts
//! æŸ¥æ‰¾ç¡®è®¤æŒ‰é’®
var findConfirmBtn = () => {
  return findTextWithinBounds("ç¡®è®¤", 480, 720, 960, 145);
};
//! æŸ¥æ‰¾æ ‡é¢˜æ–‡å­—
var findHeaderTitle = (title, contains) => {
  return findTextWithinBounds(title, 0, 0, 300, 95, { contains });
};
//! æŸ¥æ‰¾åº•éƒ¨æŒ‰é’®æ–‡å­—
var findBottomBtnText = (text, contains) => {
  return findTextWithinBounds(text, 960, 980, 960, 100, { contains });
};
//! æŸ¥æ‰¾å…³é—­å¯¹è¯æ¡†æŒ‰é’®
var findCloseDialog = () => {
  const img = "assets/UI_BtnIcon_Close.png";
  const iro = findImageWithinBounds(img, 480, 216, 960, 648, {
    threshold: 0.85
  });
  iro?.drawSelf("group_img");
  return iro;
};
//! æŸ¥æ‰¾æŠ½å¡æŒ‰é’®ï¼ˆåˆ¤æ–­å¤„äºå¤§ä¸–ç•Œæ¡ä»¶ä¸€ï¼‰
var findGachaBtn = () => {
  const img = "assets/UI_BtnIcon_Gacha.png";
  const iro = findImageWithinBounds(img, 960, 0, 960, 80, { threshold: 0.85 });
  iro?.drawSelf("group_img");
  return iro;
};
//! æŸ¥æ‰¾æ¨èå¥‡åŸŸæŒ‰é’®ï¼ˆåˆ¤æ–­å¤„äºå¤§ä¸–ç•Œæ¡ä»¶äºŒï¼‰
var findBeyondRecommendBtn = () => {
  const img = "assets/UI_BtnIcon_Beyond_Recommend.png";
  const iro = findImageWithinBounds(img, 960, 0, 960, 80, { threshold: 0.85 });
  iro?.drawSelf("group_img");
  return iro;
};
//! æŸ¥æ‰¾å¥‡åŸŸå¤§å…æŒ‰é’®ï¼ˆåˆ¤æ–­å¤„äºå¥‡åŸŸå¤§å…ï¼‰
var findBeyondHallBtn = () => {
  const img = "assets/UI_BtnIcon_Beyond_Hall.png";
  const iro = findImageWithinBounds(img, 200, 0, 150, 100, { threshold: 0.85 });
  iro?.drawSelf("group_img");
  return iro;
};
//! æŸ¥æ‰¾æœç´¢å¥‡åŸŸæŒ‰é’®
var findAllWonderlandsBtn = () => {
  return findTextWithinBounds("æœç´¢", 1320, 0, 600, 95, { contains: true });
};
//! æŸ¥æ‰¾å¥‡åŸŸæœç´¢è¾“å…¥æ¡†
var findSearchWonderlandInput = () => {
  return findTextWithinBounds("æœç´¢", 0, 120, 1920, 60, { contains: true });
};
//! æŸ¥æ‰¾å¥‡åŸŸæœç´¢è¾“å…¥æ¡†æ¸…é™¤æŒ‰é’®
var findClearInputBtn = () => {
  return findTextWithinBounds("æ¸…é™¤", 0, 120, 1920, 60);
};
//! æŸ¥æ‰¾æœç´¢å¥‡åŸŸæŒ‰é’®
var findSearchWonderlandBtn = () => {
  return findTextWithinBounds("æœç´¢", 0, 120, 1920, 60, { contains: true });
};
//! æŸ¥æ‰¾æœç´¢è¿‡äºé¢‘ç¹æç¤º
var findSearchWonderlandThrottleMsg = () => {
  return findTextWithinBounds("è¿‡äºé¢‘ç¹", 0, 0, 1920, 300, { contains: true });
};
//! æŸ¥æ‰¾ç¬¬ä¸€ä¸ªå¥‡åŸŸæœç´¢ç»“æœåç§°
var findFirstSearchResultText = () => {
  const ir = captureGameRegion();
  const ro = RecognitionObject.ocr(240, 390, 300, 50);
  return (() => {
    const list = ir.findMulti(ro);
    for (let i = 0; i < list.count; i++) {
      if (list[i] && list[i].isExist()) {
        return list[i].text;
      }
    }
  })();
};
//! ç‚¹å‡»é€‰æ‹©ç¬¬ä¸€ä¸ªæœç´¢ç»“æœä½ç½®
var clickToChooseFirstSearchResult = () => {
  click(355, 365);
};
//! æŸ¥æ‰¾è¿›å…¥æˆ¿é—´å¿«æ·é”®æŒ‰é’®
var findEnterRoomShortcut = () => {
  return findTextWithinBounds("æˆ¿é—´", 1580, 110, 320, 390, { contains: true });
};
//! æŸ¥æ‰¾é€€å‡ºæˆ¿é—´æŒ‰é’®
var findLeaveRoomBtn = () => {
  const img = "assets/UI_Icon_Leave_Right.png";
  const iro = findImageWithinBounds(img, 1570, 0, 350, 100);
  iro?.drawSelf("group_img");
  return iro;
};
//! æŸ¥æ‰¾è·³è½¬å¤§å…æŒ‰é’®
var findGoToLobbyBtn = () => {
  return findTextWithinBounds("å¤§å…", 880, 840, 1040, 110, {
    contains: true
  });
};
//! æŸ¥æ‰¾åˆ›å»ºæˆ¿é—´æŒ‰é’®
var findCreateRoomBtn = () => {
  return findTextWithinBounds("æˆ¿é—´", 960, 140, 960, 70, { contains: true });
};
//! ç‚¹å‡»åŠ å…¥å‡†å¤‡åŒºä½ç½®
var clickToPrepare = () => {
  click(770, 275);
};
//! æŸ¥æ‰¾åŠ å…¥å‡†å¤‡åŒºæç¤º
var findPrepareMsg = () => {
  return findTextWithinBounds("åŠ å…¥å‡†å¤‡", 576, 432, 768, 216, {
    contains: true
  });
};
//! æŸ¥æ‰¾å¥‡åŸŸæ”¶è—
var findBeyondFavoritesBtn = () => {
  return findTextWithinBounds("æ”¶è—", 0, 880, 200, 200, {
    contains: true
  });
};
//! æŸ¥æ‰¾ç®¡ç†å…³å¡æŒ‰é’®
var findManageStagesBtn = () => {
  return findTextWithinBounds("ç®¡ç†", 1320, 0, 600, 95, { contains: true });
};
//! æŸ¥æ‰¾ç¼–è¾‘å…³å¡å­˜æ¡£æŒ‰é’®
var findEditStageSaveBtn = () => {
  return findTextWithinBounds("ç®¡ç†", 1220, 980, 700, 100);
};
//! æŸ¥æ‰¾è¦åˆ é™¤çš„å­˜æ¡£ä½ç½®
var findSaveToDeletePos = (keyword) => findTextWithinListView(
  keyword,
  {
    x: 210,
    y: 250,
    w: 1650,
    h: 710,
    scrollLines: 7,
    lineHeight: 95
  },
  { contains: true }
);
//! æŸ¥æ‰¾å±€å¤–å­˜æ¡£åˆ—å¤´
var findExternalSaveColumnPos = () => {
  return findTextWithinBounds("å±€å¤–", 55, 190, 1810, 50, { contains: true });
};
//! æŸ¥æ‰¾åˆ é™¤å±€å¤–å­˜æ¡£å¤é€‰æ¡†å·²é€‰ä¸­çŠ¶æ€
var findDeleteExternalSaveChecked = (colPos) => {
  const img = "assets/Checkbox_Checked.png";
  const iro = findImageWithinBounds(img, colPos, 250, 290, 710, {
    threshold: 0.6,
    use3Channels: false
  });
  iro?.drawSelf("group_img");
  return iro;
};
//! æŸ¥æ‰¾åˆ é™¤å…³å¡å­˜æ¡£æŒ‰é’®
var findDeleteStageSaveBtn = () => {
  return findTextWithinBounds("åˆ é™¤æ‰€é€‰", 1220, 980, 700, 100);
};
//! æŸ¥æ‰¾å…³å¡é€€å‡ºæŒ‰é’®
var findStageEscBtn = () => {
  const img = "assets/UI_Icon_Leave.png";
  const iro = findImageWithinBounds(img, 0, 0, 100, 100, { threshold: 0.75 });
  iro?.drawSelf("group_img");
  return iro;
};
//! æŸ¥æ‰¾ä¸­æ–­æŒ‘æˆ˜æŒ‰é’®
var findExitStageBtn = () => {
  return findTextWithinBounds("ä¸­æ–­æŒ‘æˆ˜", 576, 324, 768, 432);
};
//! æŸ¥æ‰¾è·³è¿‡å¥‡åŸŸç­‰çº§æå‡é¡µé¢
var findSkipLevelUpMsg = () => {
  return findTextWithinBounds("ç©ºç™½å¤„", 610, 950, 700, 60, { contains: true });
};
//! æŸ¥æ‰¾è¿”å›æç“¦ç‰¹æŒ‰é’®
var findGotTeyvatBtn = () => {
  return findTextWithinBounds("è¿”å›", 1500, 0, 300, 95, { contains: true });
};

// src/lobby.ts
//! åˆ¤æ–­æ˜¯å¦å¤„äºå¥‡åŸŸå¤§å…
var isInLobby = () => findBeyondHallBtn() !== void 0;
//! åˆ¤æ–­æ˜¯å¦å¤„äºæç“¦ç‰¹å¤§é™†
var isInTeyvat = () => {
  return findGachaBtn() !== void 0 && findBeyondRecommendBtn() !== void 0;
};
//! é€€å‡ºå¤§å…è¿”å›æç“¦ç‰¹å¤§é™†
var exitLobbyToTeyvat = async () => {
  if (!userConfig.goToTeyvat) return;
  if (isInTeyvat()) {
    log.warn("å·²å¤„äºæç“¦ç‰¹å¤§é™†ï¼Œè·³è¿‡");
    return;
  }
  log.info("æ‰“å¼€å½“å‰å¤§å…...");
  await assertRegionAppearing(
    () => findHeaderTitle("å¤§å…", true),
    "æ‰“å¼€å½“å‰å¤§å…è¶…æ—¶",
    () => {
      keyPress("VK_F2");
    },
    { maxAttempts: 10, retryInterval: 2e3 }
  );
  log.info("è¿”å›æç“¦ç‰¹å¤§é™†...");
  const done = await waitForAction(
    isInTeyvat,
    () => {
      findGotTeyvatBtn()?.click();
      findConfirmBtn()?.click();
    },
    { maxAttempts: 120 }
  );
  if (!done) throw new Error("è¿”å›æç“¦ç‰¹å¤§é™†è¶…æ—¶");
};

// src/room.ts
var isInRoom = () => findHeaderTitle("æˆ¿é—´", true) !== void 0;
//! æ‰“å¼€äººæ°”å¥‡åŸŸ
var goToRecommendedWonderlands = async () => {
  log.info("æ‰“å¼€äººæ°”å¥‡åŸŸç•Œé¢...");
  await assertRegionAppearing(
    () => findHeaderTitle("äººæ°”", true),
    "æ‰“å¼€äººæ°”å¥‡åŸŸç•Œé¢è¶…æ—¶",
    () => {
      keyPress("VK_F6");
    }
  );
};
//! åˆ›å»ºå¹¶è¿›å…¥å¥‡åŸŸæˆ¿é—´
var createRoom = async (room) => {
  await goToRecommendedWonderlands();
  log.info("æ‰“å¼€å…¨éƒ¨å¥‡åŸŸç•Œé¢...");
  await assertRegionAppearing(
    () => findHeaderTitle("æœç´¢", true),
    "æ‰“å¼€å…¨éƒ¨å¥‡åŸŸç•Œé¢è¶…æ—¶",
    () => {
      findAllWonderlandsBtn()?.click();
    }
  );
  await sleep(1500);
  //! è®°å½•æœç´¢å‰çš„ç¬¬ä¸€ä¸ªå¥‡åŸŸåç§°
  let iwnt;
  let wi = 0;
  while (iwnt === void 0) {
    if (wi > 20) break;
    iwnt = findFirstSearchResultText();
    await sleep(500);
    wi += 1;
  }
  if (iwnt === void 0) throw new Error("åŠ è½½å…¨éƒ¨å¥‡åŸŸåˆ—è¡¨è¶…æ—¶");
  log.info("æœç´¢å‰çš„ç¬¬ä¸€ä¸ªå¥‡åŸŸåç§°: {iwnt}", iwnt);
  log.info("ç²˜è´´å¥‡åŸŸå…³å¡æ–‡æœ¬: {room}", room);
  await assertRegionAppearing(findClearInputBtn, "ç²˜è´´å…³å¡æ–‡æœ¬è¶…æ—¶", () => {
    const input = findSearchWonderlandInput();
    if (input) {
      input.click();
      inputText(room);
    }
  });
  //! ç­‰å¾…æœç´¢ç»“æœå˜åŒ–
  let fswnt;
  log.info("æœç´¢å¥‡åŸŸå…³å¡: {room}", room);
  await waitForAction(
    () => {
      if (fswnt === void 0) return false;
      //! æ£€æµ‹æœç´¢è¿‡äºé¢‘ç¹æç¤º
      if (findSearchWonderlandThrottleMsg()) return true;
      //! æ£€æµ‹æœç´¢ç»“æœæ˜¯å¦å˜åŒ–
      return fswnt.toLocaleLowerCase().trim() !== iwnt.toLocaleLowerCase().trim();
    },
    async () => {
      findSearchWonderlandBtn()?.click();
      await sleep(1e3);
      fswnt = findFirstSearchResultText();
    },
    { maxAttempts: 30, retryInterval: 200 }
  );
  log.info("æ‰“å¼€å¥‡åŸŸä»‹ç»...");
  await assertRegionAppearing(
    findCreateRoomBtn,
    "æ‰“å¼€å¥‡åŸŸä»‹ç»è¶…æ—¶",
    () => {
      const goToLobbyButton = findGoToLobbyBtn();
      if (goToLobbyButton) {
        log.info("å½“å‰ä¸åœ¨å¤§å…ï¼Œå‰å¾€å¤§å…...");
        goToLobbyButton.click();
      } else {
        log.info("é€‰æ‹©ç¬¬ä¸€ä¸ªå¥‡åŸŸå…³å¡...");
        clickToChooseFirstSearchResult();
      }
    },
    { maxAttempts: 60 }
  );
  log.info("åˆ›å»ºå¹¶è¿›å…¥æˆ¿é—´...");
  await assertRegionAppearing(
    () => findHeaderTitle("æˆ¿é—´", true),
    "åˆ›å»ºå¹¶è¿›å…¥æˆ¿é—´è¶…æ—¶",
    () => {
      findCreateRoomBtn()?.click();
    },
    { maxAttempts: 60 }
  );
};
//! è¿›å…¥å¥‡åŸŸæˆ¿é—´
var enterRoom = async (room) => {
  const inLobby = isInLobby();
  if (inLobby) {
    const enterButton = findEnterRoomShortcut();
    if (enterButton) {
      log.info("å½“å‰å·²å­˜åœ¨æˆ¿é—´ï¼Œè¿›å…¥æˆ¿é—´...", room);
      await assertRegionAppearing(
        () => findHeaderTitle("æˆ¿é—´", true),
        "è¿›å…¥æˆ¿é—´è¶…æ—¶",
        () => {
          keyPress("VK_P");
        }
      );
      return;
    }
  }
  log.info("å½“å‰ä¸åœ¨æˆ¿é—´å†…ï¼Œåˆ›å»ºæˆ¿é—´...", room);
  await createRoom(room);
};
//! ç¦»å¼€æˆ¿é—´
var leaveRoom = async () => {
  //! å½“å‰åœ¨å¤§å…ï¼Œä¸”å­˜åœ¨æˆ¿é—´
  if (isInLobby() && findEnterRoomShortcut() !== void 0 || isInRoom()) {
    log.info("å½“å‰å­˜åœ¨æˆ¿é—´ï¼Œç¦»å¼€æˆ¿é—´...");
    //! å…ˆè¿›å…¥æˆ¿é—´
    await assertRegionAppearing(
      () => findHeaderTitle("æˆ¿é—´", true),
      "è¿›å…¥æˆ¿é—´è¶…æ—¶",
      () => {
        keyPress("VK_P");
      }
    );
    //! ç¦»å¼€æˆ¿é—´
    await assertRegionAppearing(
      findBeyondHallBtn,
      "ç¦»å¼€æˆ¿é—´è¶…æ—¶",
      async () => {
        findLeaveRoomBtn()?.click();
        await sleep(1e3);
        findConfirmBtn()?.click();
      },
      { maxAttempts: 5 }
    );
  }
};

// src/save.ts
//! è¿›å…¥ç®¡ç†å…³å¡å­˜æ¡£ç•Œé¢
var goToManageStageSave = async () => {
  //! æ‰“å¼€äººæ°”å¥‡åŸŸ
  await goToRecommendedWonderlands();
  //! æ‰“å¼€å¥‡åŸŸæ”¶è—->ç®¡ç†å…³å¡
  await assertRegionAppearing(
    findEditStageSaveBtn,
    "æ‰“å¼€ç¼–è¾‘å…³å¡å­˜æ¡£æŒ‰é’®è¶…æ—¶",
    async () => {
      //! ç‚¹å‡»å¥‡åŸŸæ”¶è—
      findBeyondFavoritesBtn()?.click();
      await sleep(300);
      //! ç‚¹å‡»ç®¡ç†å…³å¡
      findManageStagesBtn()?.click();
      await sleep(300);
    },
    { maxAttempts: 5 }
  );
};
//! åˆ é™¤å…³å¡å­˜æ¡£
var deleteStageSave = async () => {
  if (!userConfig.deleteStageSave || userConfig.deleteStageSaveKeyword.trim() === "") {
    log.info("æœªå¯ç”¨åˆ é™¤å…³å¡å­˜æ¡£ï¼Œè·³è¿‡");
    return;
  }
  try {
    //! è¿›å…¥ç®¡ç†å…³å¡å­˜æ¡£ç•Œé¢
    await goToManageStageSave();
    //! é€‰ä¸­è¦åˆ é™¤çš„å…³å¡çš„å±€å¤–å­˜æ¡£
    const stagePos = await findSaveToDeletePos(userConfig.deleteStageSaveKeyword);
    if (stagePos === void 0) {
      log.warn("æœªæ‰¾åˆ°è¦åˆ é™¤çš„å…³å¡å­˜æ¡£ï¼Œè·³è¿‡");
      return;
    }
    stagePos?.drawSelf("group_text");
    const colPos = findExternalSaveColumnPos();
    if (colPos === void 0) {
      log.warn("æ— æ³•ç¡®å®šå…³å¡çš„å±€å¤–å­˜æ¡£åˆ—ä½ç½®ï¼Œè·³è¿‡");
      return;
    }
    //! è¿›å…¥ç¼–è¾‘æ¨¡å¼
    await assertRegionDisappearing(
      findEditStageSaveBtn,
      "è¿›å…¥ç¼–è¾‘æ¨¡å¼è¶…æ—¶",
      () => {
        keyPress("VK_F");
      },
      { maxAttempts: 5 }
    );
    //! è®¡ç®—å‹¾é€‰æ¡†ä½ç½®å¹¶ç‚¹å‡»
    const [cx, cy] = [(colPos.x * 2 + colPos.width) / 2, stagePos.y + 20];
    await assertRegionAppearing(
      () => findDeleteExternalSaveChecked(colPos.x),
      "å‹¾é€‰è¦åˆ é™¤çš„å±€å¤–å­˜æ¡£è¶…æ—¶",
      () => {
        click(Math.ceil(cx), Math.ceil(cy));
      },
      { maxAttempts: 5, retryInterval: 1500 }
    );
    //! ç‚¹å‡»åˆ é™¤æ‰€é€‰æŒ‰é’®
    await assertRegionDisappearing(
      () => findDeleteExternalSaveChecked(colPos.x),
      "åˆ é™¤å…³å¡å­˜æ¡£è¶…æ—¶",
      async () => {
        //! ç‰¹å¾è¾ƒä¸ºè„†å¼±ï¼Œå¤šæ¬¡ç¡®è®¤ï¼Œç¡®ä¿æˆåŠŸåˆ é™¤
        findConfirmBtn()?.click();
        await sleep(500);
        findConfirmBtn()?.click();
        findDeleteStageSaveBtn()?.click();
        await sleep(1e3);
        findConfirmBtn()?.click();
        await sleep(500);
        findConfirmBtn()?.click();
      },
      {
        maxAttempts: 5
      }
    );
  } catch (err) {
    if (isHostException(err)) throw err;
    log.warn("åˆ é™¤å…³å¡å­˜æ¡£å¤±è´¥: {error}", getErrorMessage(err));
  } finally {
    //! è¿”å›å¤§å…
    await genshin.returnMainUi();
  }
};

// src/stage.ts
//! å¯ç”¨çš„æ‰§è¡Œé€šå…³å›æ”¾æ–‡ä»¶åˆ—è¡¨
var availablePlaybackFiles = () => {
  const files = [...file.readPathSync("assets/playbacks")].map((path) => path.replace(/\\/g, "/"));
  return userConfig.playbacks.map((file2) => `assets/playbacks/${file2}`).filter((path) => files.includes(path));
};
//! ç¡®ä¿é€šå…³å›æ”¾æ–‡ä»¶å­˜åœ¨
var ensurePlaybackFilesExist = () => {
  const list = availablePlaybackFiles();
  if (list.length === 0) {
    throw new Error("æœªæ‰¾åˆ°ä»»ä½•é€šå…³å›æ”¾æ–‡ä»¶ï¼Œè¯·ç¡®ä¿å·²å½•åˆ¶å›æ”¾å¹¶æ‹·è´åˆ° assets/playbacks ç›®å½•ä¸‹");
  }
};
var playStage = async () => {
  //! ç­‰å¾…è¿›å…¥å…³å¡
  await assertRegionAppearing(
    findStageEscBtn,
    "ç­‰å¾…è¿›å…¥å…³å¡è¶…æ—¶",
    async () => {
      findBottomBtnText("å¼€å§‹æ¸¸æˆ")?.click();
      findBottomBtnText("å‡†å¤‡", true)?.click();
      //! åˆ¤æ–­æ˜¯å¦å·²ç»åŠ å…¥å‡†å¤‡åŒº
      if (findPrepareMsg()) {
        log.info("åŠ å…¥å‡†å¤‡åŒº...");
        await assertRegionDisappearing(findPrepareMsg, "ç­‰å¾…åŠ å…¥å‡†å¤‡åŒºæç¤ºæ¶ˆå¤±è¶…æ—¶");
        clickToPrepare();
      }
    },
    { maxAttempts: 60 }
  );
  //! å…³é—­æ¸¸æˆè¯´æ˜å¯¹è¯æ¡†
  await assertRegionDisappearing(
    findCloseDialog,
    "å…³é—­æ¸¸æˆè¯´æ˜å¯¹è¯æ¡†è¶…æ—¶",
    () => {
      findCloseDialog()?.click();
    },
    { maxAttempts: 10, retryInterval: 500 }
  );
  //! æ‰§è¡Œéšæœºé€šå…³å›æ”¾æ–‡ä»¶
  await execStagePlayback();
  await sleep(3e3);
  //! é€€å‡ºå…³å¡è¿”å›å¤§å…
  await exitStageToLobby();
};
//! æ‰§è¡Œé€šå…³å›æ”¾æ–‡ä»¶ï¼ˆéšæœºæŠ½å–ï¼‰
var execStagePlayback = async () => {
  const list = availablePlaybackFiles();
  const file2 = list[Math.floor(Math.random() * list.length)];
  log.info("æ‰§è¡Œé€šå…³å›æ”¾æ–‡ä»¶: {file}", file2);
  await keyMouseScript.runFile(file2);
};
//! é€€å‡ºå…³å¡
var exitStage = async () => {
  if (findStageEscBtn() === void 0) return;
  log.warn("å…³å¡è¶…æ—¶ï¼Œå°è¯•é€€å‡ºå…³å¡...");
  await assertRegionAppearing(
    findExitStageBtn,
    "ç­‰å¾…ä¸­æ–­æŒ‘æˆ˜æŒ‰é’®å‡ºç°è¶…æ—¶",
    () => {
      keyPress("VK_ESCAPE");
    },
    { maxAttempts: 5, retryInterval: 2e3 }
  );
  findExitStageBtn()?.click();
  await genshin.returnMainUi();
};
//! é€€å‡ºå…³å¡è¿”å›å¤§å…
var exitStageToLobby = async () => {
  if (isInLobby()) {
    log.warn("å·²å¤„äºå¥‡åŸŸå¤§å…ï¼Œè·³è¿‡");
    return;
  }
  log.info("é€€å‡ºå…³å¡è¿”å›å¤§å…...");
  const done = await waitForAction(
    isInLobby,
    async () => {
      //! è·³è¿‡å¥‡åŸŸç­‰çº§æå‡é¡µé¢ï¼ˆå¥‡åŸŸç­‰çº§æ¯é€¢11ã€21ã€31ã€41çº§æ—¶å‡ºç°åŠ æ˜Ÿé¡µé¢ï¼‰
      findSkipLevelUpMsg()?.click();
      //! ç‚¹å‡»åº•éƒ¨ â€œè¿”å›å¤§å…â€ æŒ‰é’®
      findBottomBtnText("å¤§å…", true)?.click();
    },
    { maxAttempts: 60 }
  );
  if (!done) {
    await exitStage();
    throw new Error("é€€å‡ºå…³å¡è¿”å›å¤§å…è¶…æ—¶");
  }
};

// main.ts
(async function() {
  //! åˆå§‹åŒ–æ¸¸æˆç¯å¢ƒ
  setGameMetrics(1920, 1080, 1.5);
  await genshin.returnMainUi();
  //! ç¡®ä¿é€šå…³å›æ”¾æ–‡ä»¶å­˜åœ¨
  ensurePlaybackFilesExist();
  //! åˆå§‹åŒ–æ•°æ®å­˜å‚¨
  const store = useStoreWithDefaults("data", {
    weekly: { expGained: 0, attempts: 0 },
    nextWeek: getNextMonday4AM().getTime()
  });
  //! æ–°çš„ä¸€å‘¨å¼€å§‹ï¼Œé‡ç½®ç»éªŒå€¼æ•°æ®
  if (Date.now() >= store.nextWeek) {
    store.weekly = { expGained: 0, attempts: 0 };
    store.nextWeek = getNextMonday4AM().getTime();
  }
  //! æ£€æŸ¥æœ¬å‘¨ç»éªŒå€¼æ˜¯å¦å·²è¾¾ä¸Šé™
  if (store.weekly.expGained >= userConfig.expWeeklyLimit) {
    if (userConfig.force) {
      log.warn("æœ¬å‘¨è·å–ç»éªŒå€¼å·²è¾¾ä¸Šé™ï¼Œå¼ºåˆ¶æ‰§è¡Œ");
    } else {
      log.warn("æœ¬å‘¨è·å–ç»éªŒå€¼å·²è¾¾ä¸Šé™ï¼Œè·³è¿‡æ‰§è¡Œ");
      return;
    }
  }
  //! è®¡ç®—æœ¬æ¬¡æœ¬å‘¨å‰©ä½™å¯è·å–ç»éªŒå€¼
  let expRemaining = userConfig.expWeeklyLimit - store.weekly.expGained;
  expRemaining = expRemaining > 0 ? expRemaining : userConfig.expWeeklyLimit;
  //! è®¡ç®—éœ€è¦è¿›è¡Œçš„å°è¯•æ¬¡æ•°
  let attempts = Math.ceil(expRemaining / userConfig.expPerAttempt);
  attempts = userConfig.thisAttempts > 0 ? userConfig.thisAttempts : attempts;
  //! ç¦»å¼€å½“å‰æ‰€åœ¨æˆ¿é—´ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
  await leaveRoom();
  //! åˆ›å»ºè¿›åº¦è¿½è¸ªå™¨
  const tracker = new ProgressTracker(attempts);
  //! è¿­ä»£å°è¯•
  try {
    for (let i = 0; i < attempts; i++) {
      tracker.print(`å¼€å§‹æœ¬å‘¨ç¬¬ ${store.weekly.attempts + 1} æ¬¡å¥‡åŸŸæŒ‘æˆ˜...`);
      //! åˆ é™¤å…³å¡å­˜æ¡£
      await deleteStageSave();
      //! è¿›å…¥æˆ¿é—´
      await enterRoom(userConfig.room);
      //! æ¸¸ç©å…³å¡
      await playStage();
      //! å…³å¡ç»“æŸï¼Œæ›´æ–°æ•°æ®å­˜å‚¨
      store.weekly.attempts += 1;
      store.weekly.expGained += userConfig.expPerAttempt;
      tracker.tick({ increment: 1 });
      //! æœ¬å‘¨å·²è·å–ç»éªŒå€¼è¾¾åˆ°ä¸Šé™ï¼Œè·³å‡ºå¾ªç¯
      if (store.weekly.expGained >= userConfig.expWeeklyLimit) {
        if (!userConfig.force) {
          log.warn("æœ¬å‘¨å·²è·å–ç»éªŒå€¼è¾¾åˆ°ä¸Šé™ï¼Œåœæ­¢æ‰§è¡Œ");
          break;
        }
      }
    }
  } catch (err) {
    //! å‘ç”Ÿä¸»æœºå¼‚å¸¸ï¼ˆå¦‚ï¼šä»»åŠ¡å–æ¶ˆå¼‚å¸¸ç­‰ï¼‰ï¼Œæ— æ³•å†ç»§ç»­æ‰§è¡Œ
    if (isHostException(err)) throw err;
    //! å‘ç”Ÿè„šæœ¬æµç¨‹å¼‚å¸¸ï¼Œå°è¯•é€€å‡ºå…³å¡ï¼ˆå¦‚æœåœ¨å…³å¡ä¸­ï¼‰
    await exitStage();
    log.error("è„šæœ¬æ‰§è¡Œå‡ºé”™: {error}", getErrorMessage(err));
  }
  //! è¿”å›æç“¦ç‰¹å¤§é™†
  await exitLobbyToTeyvat();
})();
